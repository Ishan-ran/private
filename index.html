<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GhostLink</title>
  <style>
    /* --- CORE THEME --- */
    body { margin: 0; background: #ece5dd; font-family: sans-serif; height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; user-select: none; -webkit-user-select: none; }
    
    /* --- LOGIN SCREEN --- */
    #lock-screen { 
      position: fixed; 
      inset: 0; 
      z-index: 100; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      background: #ece5dd; 
    }

    .lock-logo { width: 80px; height: 80px; background: #075e54; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; color: white; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    input.pass { padding: 15px; font-size: 16px; border-radius: 10px; border: 1px solid #ddd; text-align: center; margin-bottom: 10px; width: 80%; max-width: 300px; outline: none; background: white; }
    input.pass:focus { border-color: #075e54; }
    button.btn { padding: 12px 30px; background: #075e54; color: white; border: none; border-radius: 30px; font-size: 16px; cursor: pointer; font-weight: bold; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    button.btn:active { transform: scale(0.98); }
    
    /* --- ANIMATION OVERLAYS --- */
    #matrix-screen, #sylus-screen, #goofy-screen {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 20000;
      overflow: hidden;
      align-items: center;
      justify-content: center;
    }

    /* Matrix */
    #matrix-screen { background: black; }
    #matrix-text {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: #0F0; font-family: 'Courier New', monospace; font-size: 28px; font-weight: bold;
      text-shadow: 0 0 10px #0F0; opacity: 0; transition: opacity 1s;
    }

    /* Sylus (Tenor) */
    #sylus-screen { background: black; }
    .tenor-gif-embed { width: 100%; height: 100%; pointer-events: none; opacity: 0.6; }
    #sylus-text {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: #ff0033; font-family: 'Georgia', serif; font-size: 22px; font-style: italic;
      text-shadow: 0 0 15px black; text-align: center; width: 90%;
      opacity: 0; transition: opacity 2s ease-in; z-index: 20001;
    }

    /* Goofy */
    #goofy-screen { background: #111; }
    @keyframes waveColor { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    #goofy-text {
      font-family: 'Brush Script MT', cursive; font-size: 38px; text-align: center; max-width: 80%; padding: 20px;
      background: linear-gradient(90deg, #8B0000, #DC143C, #FF0000, #DC143C, #8B0000);
      background-size: 300% 300%; -webkit-background-clip: text; background-clip: text; color: transparent;
      animation: waveColor 4s ease infinite; filter: drop-shadow(0px 0px 3px #800080);
      opacity: 0; transition: opacity 1.5s ease-in-out;
    }

    /* --- APP UI --- */
    #contact-screen { display: none; flex-direction: column; height: 100%; background: #fff; position: relative; z-index: 1; }
    .app-header { background: #075e54; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10; }
    .header-content h1 { margin: 0; font-size: 20px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .edit-self-btn { background: none; border: none; color: rgba(255,255,255,0.7); font-size: 16px; cursor: pointer; }
    .self-avatar-small { width: 30px; height: 30px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #075e54; background-size: cover; background-position: center; border: 2px solid rgba(255,255,255,0.5); }
    
    .contact-list { flex: 1; overflow-y: auto; padding-bottom: 80px; }
    .contact { border-bottom: 1px solid #f0f0f0; padding: 15px; }
    .contact-main { display: flex; align-items: center; cursor: pointer; justify-content: space-between; }
    .contact-main:active { background: #f9f9f9; }
    .contact-left { display: flex; align-items: center; gap: 15px; flex: 1; min-width: 0; }
    .avatar { width: 50px; height: 50px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #fff; font-weight: bold; flex-shrink: 0; background-size: cover; background-position: center; }
    .info { overflow: hidden; flex: 1; }
    .info h3 { margin: 0; font-size: 17px; color: #111; font-weight: 500; }
    .info p { margin: 4px 0 0; font-size: 14px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .contact-actions { display: flex; align-items: center; gap: 5px; }
    .action-icon { background: none; border: none; font-size: 18px; cursor: pointer; opacity: 0.5; padding: 8px; }
    .delete-btn { color: #ff4444; }
    .edit-btn { color: #075e54; }
    .sub-contacts { padding-left: 65px; display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .sub-badge { background: #e8f5e9; color: #075e54; border: 1px solid #075e54; border-radius: 12px; padding: 4px 10px; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
    
    .fab { position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; background: #25D366; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; border: none; z-index: 20; }
    
    /* --- CHAT SCREEN --- */
    #chat-screen { display: none; flex-direction: column; height: 100%; background: #e5ddd5; position: relative; background-size: cover; background-position: center; z-index: 1; } 
    #chat-screen.has-wallpaper::before { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.4); pointer-events: none; }
    
    .chat-header { background: #075e54; color: white; padding: 10px 15px; display: flex; align-items: center; gap: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); z-index: 10; }
    .back-btn { background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0 5px; margin-right: 5px; }
    .header-profile { display: flex; align-items: center; gap: 10px; flex: 1; }
    .header-avatar { width: 40px; height: 40px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #075e54; font-size: 20px; background-size: cover; background-position: center; }
    .header-info { display: flex; flex-direction: column; justify-content: center; }
    .header-info h4 { margin: 0; font-size: 16px; font-weight: 500; line-height: 1.2; }
    #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 6px; scroll-behavior: smooth; z-index: 1; }
    
    /* Messages */
    .msg { padding: 6px 10px; border-radius: 7.5px; max-width: 75%; width: fit-content; font-size: 15px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); line-height: 1.3; cursor: pointer; display: flex; flex-direction: column; }
    .msg.me { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 0; align-items: flex-end; margin-right: 5px; }
    .msg.me::before { content: ""; position: absolute; top: 0; right: -8px; width: 0; height: 0; border-style: solid; border-width: 0 0 10px 10px; border-color: transparent transparent transparent #dcf8c6; }
    .msg.her { align-self: flex-start; background: #fff; border-top-left-radius: 0; align-items: flex-start; margin-left: 5px; }
    .msg.her::before { content: ""; position: absolute; top: 0; left: -8px; width: 0; height: 0; border-style: solid; border-width: 0 10px 10px 0; border-color: transparent #fff transparent transparent; }

    .msg-sender-name { font-size: 10px; color: #e53935; font-weight: bold; margin-bottom: 2px; } 
    .msg-content { white-space: pre-wrap; word-wrap: break-word; max-width: 100%; }
    .meta-row { display: flex; align-items: center; justify-content: flex-end; gap: 3px; margin-top: 2px; }
    .time { font-size: 10px; color: #999; }
    .tick { font-size: 10px; }
    .msg img { max-width: 100%; border-radius: 5px; margin-bottom: 2px; display: block; min-width: 50px;}
    .audio-msg { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.05); padding: 5px; border-radius: 5px; margin-bottom: 2px; min-width: 150px; }
    .play-icon { font-size: 20px; cursor: pointer; }
    .wave { height: 3px; background: #999; flex: 1; border-radius: 2px; }
    
    #reply-preview { display: none; background: #f0f0f0; border-left: 5px solid #075e54; padding: 8px 12px; justify-content: space-between; align-items: center; border-top: 1px solid #ddd; }
    #reply-info { flex: 1; overflow: hidden; }
    #reply-to-name { font-weight: bold; color: #075e54; font-size: 12px; }
    #reply-to-text { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #cancel-reply { border: none; background: transparent; font-size: 18px; cursor: pointer;}
    .quote-box { background: rgba(0,0,0,0.06); border-left: 4px solid #075e54; border-radius: 4px; padding: 4px 8px; margin-bottom: 4px; font-size: 12px; color: #555; display: flex; flex-direction: column; }
    
    #input-area { display: flex; padding: 8px; background: #f0f0f0; gap: 6px; align-items: flex-end; min-height: 50px; box-sizing: border-box; z-index: 1; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
    #input-area.hidden { display: none !important; } 
    #txt { flex: 1; padding: 10px 15px; border-radius: 20px; border: none; outline: none; font-size: 15px; background: white; resize: none; font-family: inherit; height: 22px; max-height: 120px; overflow-y: auto; line-height: 20px;}
    .icon-btn { background: transparent; color: #555; width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; flex-shrink: 0;}
    .icon-btn.active { color: #d32f2f; animation: pulse 1.5s infinite; }
    .send-btn { background: #075e54; color: white; margin-bottom: 1px; width: 40px; height: 40px; font-size: 18px;} 
    #imgInput, #wallpaperInput, #profilePicInput { display: none; }
    .action-btn { background: transparent; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px; }

    /* Typing Bubble */
    .typing-bubble { background: #fff; padding: 10px 15px; border-radius: 20px; border-bottom-left-radius: 2px; display: none; align-items: center; gap: 4px; width: fit-content; margin-left: 5px; margin-bottom: 10px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
    .dot { width: 6px; height: 6px; background: #b6b5ba; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
    .dot:nth-child(1) { animation-delay: -0.32s; } .dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

    /* Unread Badge */
    .unread-badge { background: #25D366; color: white; font-size: 11px; font-weight: bold; min-width: 20px; height: 20px; border-radius: 10px; display: none; align-items: center; justify-content: center; padding: 0 5px; margin-left: auto; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }

    /* Modals */
    #wp-modal, #profile-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
    .wp-card { background: white; width: 80%; max-width: 300px; border-radius: 10px; padding: 20px; text-align: center; max-height: 80vh; overflow-y: auto; }
    .wp-btn { display: block; width: 100%; padding: 10px; margin: 10px 0; background: #eee; border: none; border-radius: 5px; cursor: pointer; }
    .wp-btn.primary { background: #075e54; color: white; font-weight: bold; }
    .wp-btn.danger { background: #ff4444; color: white; font-weight: bold; }
    .wp-btn.close { background: #999; color: white; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
  </style>
</head>
<body>

  <!-- LOGIN SCREEN -->
  <div id="lock-screen">
    <div class="lock-logo">üîí</div>
    <h2 style="color:#444; margin-bottom:20px;">GhostLink</h2>
    <input type="text" id="username" class="pass" placeholder="Username" autocomplete="off">
    <input type="password" id="pass" class="pass" placeholder="Password" autocomplete="off">
    <button class="btn" onclick="attemptLogin()">Enter</button>
    <p id="error" style="color:red; margin-top:10px; opacity:0; font-size:14px;">Access Denied</p>
  </div>

  <!-- MATRIX ANIMATION -->
  <div id="matrix-screen">
    <canvas id="matrix-canvas"></canvas>
    <div id="matrix-text">Welcome, Lucifer.</div>
  </div>

  <!-- SYLUS ANIMATION -->
  <div id="sylus-screen">
    <div id="tenor-container" style="width:100%; height:100%; position:absolute; top:0; left:0; z-index:20000; opacity:0.6;"></div>
    <div id="sylus-text">Closer. I want to hear your heartbeat sync with mine.</div>
  </div>

  <!-- GOOFY ANIMATION -->
  <div id="goofy-screen">
    <div id="goofy-text"></div>
  </div>

  <!-- APP: CONTACT LIST -->
  <div id="contact-screen">
    <div class="app-header">
      <div class="header-content">
        <div style="display:flex;align-items:center;gap:10px;">
            <div class="self-avatar-small" id="self-avatar-display">üë§</div>
            <h1>Chats <button class="edit-self-btn" onclick="openProfileModal()" title="Edit Profile">‚úé</button></h1>
        </div>
        <span style="font-size:14px; opacity:0.8;" id="header-role">Guest</span>
      </div>
    </div>
    <div class="contact-list" id="contact-list-container"></div>
    <button class="fab" onclick="handleAddButton()">+</button>
  </div>

  <!-- APP: CHAT ROOM -->
  <div id="chat-screen">
    <div class="chat-header">
      <button class="back-btn" onclick="goBack()">‚Üê</button>
      <div class="header-profile">
        <div class="header-avatar" id="chat-avatar">üë§</div>
        <div class="header-info">
          <h4 id="chat-name">Name</h4>
        </div>
      </div>
      <button class="action-btn" onclick="openWallpaperModal()">üñºÔ∏è</button>
    </div>
    <div id="messages"></div>
    
    <div id="reply-preview">
      <div id="reply-info">
        <div id="reply-to-name">Replying...</div>
        <div id="reply-to-text"></div>
      </div>
      <button id="cancel-reply" onclick="cancelReply()">‚úñ</button>
    </div>

    <div id="input-area">
      <button class="icon-btn" onclick="document.getElementById('imgInput').click()">üì∑</button>
      <input type="file" id="imgInput" accept="image/*" onchange="handleImageUpload(this)">
      <textarea id="txt" placeholder="Message" rows="1"></textarea>
      <button class="icon-btn" id="mic-btn" onclick="toggleRecording()">üéôÔ∏è</button>
      <button class="icon-btn send-btn" onclick="send()">‚û§</button>
    </div>
  </div>

  <!-- MODALS -->
  <div id="wp-modal">
    <div class="wp-card">
      <h3>Wallpaper</h3>
      <button class="wp-btn primary" onclick="document.getElementById('wallpaperInput').click()">Upload</button>
      <button class="wp-btn" onclick="useLastPhoto()">Use Last Photo</button>
      <button class="wp-btn" onclick="resetWallpaper()">Reset</button>
      <button class="wp-btn close" onclick="closeWallpaperModal()">Cancel</button>
      <input type="file" id="wallpaperInput" accept="image/*" onchange="handleWallpaperUpload(this)">
    </div>
  </div>

  <div id="profile-modal">
    <div class="wp-card">
      <h3>Edit Profile</h3>
      <button class="wp-btn primary" onclick="renameSelf()">Change Name</button>
      <button class="wp-btn" onclick="document.getElementById('profilePicInput').click()">Change Profile Pic</button>
      <input type="file" id="profilePicInput" accept="image/*" onchange="handleProfilePicUpload(this)">
      <button class="wp-btn danger" onclick="changePassword()">Change Password</button>
      <button class="wp-btn close" onclick="document.getElementById('profile-modal').style.display = 'none'">Cancel</button>
    </div>
  </div>

  <!-- TENOR SCRIPT -->
  <script type="text/javascript" async src="https://tenor.com/embed.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, getDoc, getDocs, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc, setDoc, updateDoc, deleteField, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDznEmz6rxBJ_2QAgWIoEzWPBpM5QvocRQ",
      authDomain: "our-space-cbc39.firebaseapp.com",
      projectId: "our-space-cbc39",
      storageBucket: "our-space-cbc39.firebasestorage.app",
      messagingSenderId: "930162638208",
      appId: "1:930162638208:web:72cac87408d931efe01565"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const ADMIN_EMAIL = "admin@secret.com"; 
    
    let currentCollection = null;
    let currentUserDisplay = null; 
    let currentUserId = null; 
    let isAdmin = false;
    let isSpying = false;
    let guestData = null; 
    
    let unsubscribeChat, unsubscribeUsers, lastImageSent, replyTarget;
    let mediaRecorder, audioChunks = [];
    let lastTypingTime = 0;
    let typingTimeout;
    let globalUnreadMap = {}; 
    let unreadListeners = [];

    // --- LOGIN LOGIC ---
    window.attemptLogin = async () => {
      const username = document.getElementById('username').value.trim().toLowerCase();
      const p = document.getElementById('pass').value.trim(); 
      const errorMsg = document.getElementById('error');

      try {
        if (username === 'lucifer') {
            await signInWithEmailAndPassword(auth, ADMIN_EMAIL, p);
            document.getElementById('lock-screen').style.display = 'none';
            runMatrixEffect(() => {
                isAdmin = true; currentUserDisplay = "Ishan";
                unlock(); initAdminDashboard();
            });
        } else {
            // Wait for anonymous auth FIRST
            await signInAnonymously(auth);
            
            // NORMAL LOGIN CHECK (Password is the Doc ID)
            const docRef = doc(db, "users", p.toLowerCase());
            const snap = await getDoc(docRef);
            
            if (snap.exists()) { 
              isAdmin = false; guestData = snap.data(); 
              currentUserDisplay = guestData.name;
              currentUserId = p.toLowerCase();

              // Special Triggers
              if (p.toLowerCase() === 'kaneshiro' || username === 'kaneshiro') {
                  document.getElementById('lock-screen').style.display = 'none';
                  runSylusEffect(() => { unlock(); initGuestDashboard(); });
                  return;
              }
              if (username === 'goofy' || p.toLowerCase() === 'goofy') {
                    document.getElementById('lock-screen').style.display = 'none';
                    updateDoc(docRef, { loginCount: (guestData.loginCount || 0) + 1 });
                    runGoofyEffect(() => { unlock(); initGuestDashboard(); });
                    return;
              }
              unlock(); initGuestDashboard(); 
            } else { 
               // Auto-Registration
               const newUserData = {
                   name: "User" + Math.floor(Math.random() * 1000),
                   collection: "chats_" + Date.now(),
                   color: "#" + Math.floor(Math.random()*16777215).toString(16),
                   created: serverTimestamp()
               };
               await setDoc(docRef, newUserData);
               await setDoc(doc(db, "directory", newUserData.name.toLowerCase()), { uid: p.toLowerCase(), name: newUserData.name });
               
               isAdmin = false; guestData = newUserData;
               currentUserDisplay = newUserData.name;
               currentUserId = p.toLowerCase();
               
               unlock(); initGuestDashboard();
            }
        }
      } catch (e) {
        console.error(e);
        errorMsg.innerText = "Access Denied"; errorMsg.style.opacity = '1';
        setTimeout(() => errorMsg.style.opacity = '0', 2000);
      }
    };

    function unlock() { 
        document.getElementById('lock-screen').style.display = 'none'; 
        // Start Presence - SAFEGUARDED against null currentUserId
        if (currentUserId) {
            updateDoc(doc(db, "users", currentUserId), { lastActive: serverTimestamp() }).catch(err => console.log("Presence skipped for admin/spy"));
            setInterval(() => { 
                if(currentUserId) updateDoc(doc(db, "users", currentUserId), { lastActive: serverTimestamp() }).catch(err => console.log("Presence skipped"));
            }, 60000);
        }
    }

    // --- ANIMATIONS ---
    function runMatrixEffect(callback) {
        const screen = document.getElementById('matrix-screen');
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        const textEl = document.getElementById('matrix-text');
        
        screen.style.display = 'block';
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const chars = '0101010101ABCDEFGHIJKLMNOPQRSTUVWXYZ'; 
        const fontSize = 16;
        const columns = canvas.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);
        let active = true;
        
        function draw() {
            if(!active) return;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#0F0'; 
            ctx.font = fontSize + 'px monospace';
            for(let i = 0; i < drops.length; i++) {
                const text = chars.charAt(Math.floor(Math.random() * chars.length));
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                if(drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
            requestAnimationFrame(draw);
        }
        draw();
        setTimeout(() => { textEl.style.opacity = '1'; }, 1000);
        setTimeout(() => {
            active = false;
            screen.style.transition = 'opacity 1s';
            screen.style.opacity = '0';
            setTimeout(() => { screen.style.display = 'none'; screen.style.opacity = '1'; callback(); }, 1000);
        }, 15000); 
    }

    function runSylusEffect(callback) {
        const screen = document.getElementById('sylus-screen');
        const textEl = document.getElementById('sylus-text');
        const container = document.getElementById('tenor-container');
        const gifs = ['12246501057951952738', '13089372204133323511', '17364932671361395976', '896520473432927341'];
        const randomId = gifs[Math.floor(Math.random() * gifs.length)];
        
        container.innerHTML = `<div class="tenor-gif-embed" data-postid="${randomId}" data-share-method="host" data-aspect-ratio="1" data-width="100%"></div>`;
        const script = document.createElement('script');
        script.type = 'text/javascript'; script.async = true; script.src = 'https://tenor.com/embed.js';
        document.body.appendChild(script);

        screen.style.display = 'flex';
        setTimeout(() => { textEl.style.opacity = '1'; }, 500);
        setTimeout(() => {
            screen.style.transition = 'opacity 1.5s'; screen.style.opacity = '0';
            setTimeout(() => { screen.style.display = 'none'; screen.style.opacity = '1'; textEl.style.opacity = '0'; container.innerHTML = ""; callback(); }, 1500);
        }, 15000); 
    }

    const flirtyDatabase = [
        "Sunn, tu meri favorite notification hai. ‚ù§Ô∏è", "Bawli, bas tu chahiye.", "Oye, aaj itni sundar kyu lag rahi hai?", "Tujhse baat kiye bina din adhoora lagta hai.", "You are my favorite distraction.", "Google maps delete kar diya... teri aankhon mein kho gaya hu.",
        "Sunn, doctor ne bola hai Vitamin 'U' ki kami hai.", "Tu online aati hai toh dil ki dhadkan badh jaati hai.", "Meri subah aur raat bas tere khayalon se shuru hoti hai.", "Oye Nautanki, I love you more than you know.", "Duniya ke liye tu ek insaan hai, par mere liye tu puri duniya hai.",
        "Tera naam password rakh lu? Sabse secure feel karunga.", "Pagal hu main. Tera pagal.", "Tere bina sab boring hai yaar.", "Kaash tu abhi yaha hoti. Hug karna hai.", "Tera haath pakad ke puri zindagi chalna hai.", "Pata nahi kyu, par tu sabse alag hai.",
        "Teri aawaaz sun lun toh din ban jaata hai.", "Distance sucks, but you are worth it.", "Mera dil, meri jaan, mera sab kuch... bas tu.", "Sirf meri hai tu. Samjhi?", "Reply fast kar, varna aake daant tod dunga.", "Kaha busy hai? Mujhe attention chahiye. Abhi.",
        "Oye, zyada bhav mat kha. Pyar karta hu isliye jhel raha hu.", "Mujhse jhooth mat bolna kabhi, main aankhein padh leta hu.", "Sunn, gussa thook de aur smile kar. Jaldi.", "Tere alawa kisi aur ko dekhu toh paap lagega mujhe.", "You are mine. End of discussion.",
        "Phone rakh aur soja, sapno mein milte hai.", "Oye chudail, miss kar raha hu tujhe.", "Kisi aur ladke ne text kiya toh block kar dena. Seedha.", "Meri hai tu, uspe koi doubt mat rakhna.", "Tujhe share karne ka koi irada nahi hai mera.",
        "Haq hai mera tujhpe. Poora ka poora.", "Don't dare to leave me. Mar jaunga tere bina.", "Tu meri zid hai, aur main apni zid kabhi nahi chodta.", "Nazar na lage tujhe, isliye kaala teeka laga ke ghum.", "You belong to me. Remember that.",
        "Mere alawa kisi aur ki taraf dekha toh aankhein nikaal lunga.", "Bas main aur tu. Teesra koi nahi chahiye.", "Akal nahi hai tujhme, par cute bohot hai.", "Bhagwan ne fursat mein banaya toh tha, par bheja daalna bhool gaye.",
        "Itna makeup mat kar, waise hi darawni lagti hai. (Jk, love u)", "Sunn, tu shakaal se innocent aur dimaag se shaitaan hai.", "Mere bacchon ki maa banegi? (Just asking)", "Apni smile sambhal ke rakh, bahut qaatil hai.", "Oye Gadhi, I miss your stupidity.",
        "Tu roti hai toh joker lagti hai, hasa kar.", "Bawli ladki, dimaag mat kha, khana kha.", "Tujhe jhelne ka award milna chahiye mujhe.", "Cartoon hai tu poori. Mera cartoon.", "Drama Queen award goes to... You.", "Tere jokes pe hassi nahi aati, par tujhpe pyaar aata hai.",
        "Chup chap reply kar, varna ghar se utha lunga.", "Tu 'Mental Hospital' se kab bhaagi?", "Moti ho rahi hai tu... (Mazak kar raha hu jaan!)", "Itna gussa naak pe kyu rehta hai? Cute lagti hai waise.", "Tu paida hi pagal hui thi ya mere pyaar mein hui?", "Bandariya kahi ki. Love you.",
        "Dimag ka dahi mat kar, I love you bol aur khatam kar.", "Suno... Tum achi lagti ho. Bohot.", "Naraz mat hua kar, saansein atak jaati hai meri.", "Tujhe khone ke khayal se bhi darr lagta hai.", "Har dua mein bas tera naam aata hai.",
        "Tu meri aakhri umeed hai.", "Tere saath budha hona hai mujhe.", "Jab tak tu hai, sab theek hai.", "Mera sukoon bas teri baaton mein hai.", "Duniya jalne de, hum saath rahenge.", "Tere bina ek pal bhi sadiyaan lagta hai.",
        "Tu ruh tak utar gayi hai.", "Main tujhse nahi, teri aatma se pyaar karta hu.", "Tu mera aaj bhi hai aur aane wala kal bhi.", "Bas tera haath mere haath mein ho, toh duniya jeet lu.", "Tere bina main adhura hu, poora karde mujhe.",
        "Tu meri zindagi ki sabse khoobsurat galti hai.", "Tujhe dekhta hu toh saari thakan door ho jaati hai.", "Tu mere liye kya hai, main shabdon mein nahi bata sakta.", "Meri har dhadkan tera naam leti hai.", "Tujhse shuru, tujhpe khatam.",
        "Mine. ‚ù§Ô∏è", "Bawli forever.", "Love you, Idiot.", "Sirf Tum.", "My Peace.", "Heartbeat.", "Soulmate shit.", "Oye Heroine!", "Meri Zindagi.", "Pyaar hai tujhse.", "Tu + Main = ‚ù§Ô∏è", "Forever wala love.", "Cutiepie.", "My Happiness.", "Jaan hai tu.", "Miss you.", "Need you.", "Want you.", "Love you.", "Only you."
    ];

    function runGoofyEffect(callback) {
        const screen = document.getElementById('goofy-screen');
        const textEl = document.getElementById('goofy-text');
        const loginCount = (guestData.loginCount || 0);
        const index = loginCount % flirtyDatabase.length; 
        const uniqueLine = flirtyDatabase[index];
        textEl.innerText = uniqueLine;
        screen.style.display = 'flex';
        setTimeout(() => { textEl.style.opacity = '1'; }, 500);
        setTimeout(() => {
            screen.style.transition = 'opacity 1.5s'; screen.style.opacity = '0';
            setTimeout(() => { screen.style.display = 'none'; screen.style.opacity = '1'; textEl.style.opacity = '0'; callback(); }, 1500);
        }, 6000); 
    }

    // --- DASHBOARDS ---
    function initAdminDashboard() {
      document.getElementById('contact-screen').style.display = 'flex';
      document.getElementById('header-role').innerText = "God Mode";
      document.querySelector('.edit-self-btn').style.display = 'none'; 
      
      const q = query(collection(db, "users"), orderBy("created", "desc"));
      unsubscribeUsers = onSnapshot(q, (snap) => {
        unreadListeners.forEach(u => u()); unreadListeners = [];
        const list = document.getElementById('contact-list-container'); list.innerHTML = "";
        
        snap.forEach(async (docSnap) => {
          const u = docSnap.data(); 
          const uid = docSnap.id;
          
          // Outer Container
          const div = document.createElement('div'); 
          div.className = 'contact';
          
          // Main Row
          const mainRow = document.createElement('div');
          mainRow.className = 'contact-main';
          mainRow.onclick = () => openChat(u.collection, u.name, u.color, false, uid);
          
          // Left Side (Avatar + Info)
          const leftDiv = document.createElement('div');
          leftDiv.className = 'contact-left';
          
          // Avatar
          const avatar = document.createElement('div');
          avatar.className = 'avatar';
          if (u.profilePic) {
              avatar.style.backgroundImage = `url('${u.profilePic}')`;
              avatar.style.backgroundColor = 'transparent';
              avatar.style.color = 'transparent';
          } else {
              avatar.style.background = u.color;
              avatar.textContent = u.name[0];
          }
          
          // Info
          const infoDiv = document.createElement('div');
          infoDiv.className = 'info';
          const h3 = document.createElement('h3'); h3.textContent = u.name;
          const p = document.createElement('p'); p.textContent = `Pass: ${uid}`;
          infoDiv.append(h3, p);
          
          leftDiv.append(avatar, infoDiv);
          
          // Actions (Right Side)
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'contact-actions';
          
          const badge = document.createElement('div');
          badge.className = 'unread-badge';
          badge.id = `badge-${u.collection}`;
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'action-icon delete-btn';
          deleteBtn.textContent = 'üóëÔ∏è';
          deleteBtn.onclick = (e) => deleteUser(e, uid); // Secure Function Call
          
          actionsDiv.append(badge, deleteBtn);
          mainRow.append(leftDiv, actionsDiv);
          
          // Sub Contacts Container
          const subContainer = document.createElement('div');
          subContainer.className = 'sub-contacts';
          subContainer.id = `subs-${uid}`;
          
          div.append(mainRow, subContainer);
          list.appendChild(div);
          
          subscribeToUnread(u.collection, `badge-${u.collection}`);

          // Fetch Sub Contacts
          const subSnap = await getDocs(query(collection(db, `users/${uid}/contacts`)));
          subSnap.forEach(sub => {
            const g = sub.data(); 
            const badge = document.createElement('div'); 
            badge.className = 'sub-badge'; 
            badge.textContent = `üìÅ ${g.name}`; 
            badge.onclick = (e) => { e.stopPropagation(); openChat(g.roomId, `${u.name}'s: ${g.name}`, g.color, true); };
            subContainer.appendChild(badge);
          });
        });
      });
    }

    function initGuestDashboard() {
      document.getElementById('contact-screen').style.display = 'flex';
      document.getElementById('header-role').innerText = currentUserDisplay;
      
      const selfAv = document.getElementById('self-avatar-display');
      if (guestData.profilePic) { selfAv.innerText = ""; selfAv.style.backgroundImage = `url('${guestData.profilePic}')`; } 
      else { selfAv.innerText = currentUserDisplay[0]; selfAv.style.backgroundImage = ""; }

      unsubscribeUsers = onSnapshot(query(collection(db, `users/${currentUserId}/contacts`)), (snap) => {
        unreadListeners.forEach(u => u()); unreadListeners = [];
        const list = document.getElementById('contact-list-container'); list.innerHTML = "";
        
        // Add "Ishan" (Admin) Contact manually
        renderGuestContact(list, "Ishan ‚ù§Ô∏è", "#075e54", "Private Chat", guestData.collection, null);
        subscribeToUnread(guestData.collection, `badge-${guestData.collection}`);
        
        snap.forEach(doc => { 
            const d = doc.data(); 
            renderGuestContact(list, d.name, d.color, "Chat", d.roomId, doc.id); 
            subscribeToUnread(d.roomId, `badge-${d.roomId}`); 
        });
      });
    }

    function renderGuestContact(container, name, color, subtext, roomId, contactDocId) {
      const div = document.createElement('div'); 
      div.className = 'contact';
      
      const mainRow = document.createElement('div');
      mainRow.className = 'contact-main';
      mainRow.onclick = () => openChat(roomId, name, color, false);
      
      const leftDiv = document.createElement('div');
      leftDiv.className = 'contact-left';
      
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.style.background = color;
      avatar.textContent = name[0];
      
      const infoDiv = document.createElement('div');
      infoDiv.className = 'info';
      const h3 = document.createElement('h3'); h3.textContent = name;
      const p = document.createElement('p'); p.textContent = subtext;
      infoDiv.append(h3, p);
      leftDiv.append(avatar, infoDiv);
      
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'contact-actions';
      
      const badge = document.createElement('div');
      badge.className = 'unread-badge';
      badge.id = `badge-${roomId}`;
      actionsDiv.appendChild(badge);
      
      if (contactDocId) {
          const editBtn = document.createElement('button');
          editBtn.className = 'action-icon edit-btn';
          editBtn.textContent = '‚úé';
          editBtn.onclick = (e) => renameContact(e, contactDocId, name);
          
          const delBtn = document.createElement('button');
          delBtn.className = 'action-icon delete-btn';
          delBtn.textContent = 'üóëÔ∏è';
          delBtn.onclick = (e) => deleteContact(e, contactDocId);
          
          actionsDiv.append(editBtn, delBtn);
      }
      
      mainRow.append(leftDiv, actionsDiv);
      div.appendChild(mainRow);
      container.appendChild(div);
    }

    function subscribeToUnread(roomId, badgeId) {
        const unsub = onSnapshot(query(collection(db, roomId), where("read", "==", false)), (snap) => {
            let count = 0; snap.forEach(doc => { if (doc.data().sender !== currentUserDisplay) count++; });
            const badge = document.getElementById(badgeId);
            if (badge) { badge.style.display = count > 0 ? 'flex' : 'none'; badge.innerText = count > 9 ? '9+' : count; }
            globalUnreadMap[roomId] = count; 
        }); unreadListeners.push(unsub); 
    }

    // --- CHAT LOGIC ---
    window.openChat = async (roomId, name, color, asSpy, partnerUid) => {
      currentCollection = roomId; isSpying = asSpy;
      document.getElementById('contact-screen').style.display = 'none';
      document.getElementById('chat-screen').style.display = 'flex';
      document.getElementById('chat-name').innerText = name;
      
      const av = document.getElementById('chat-avatar');
      av.innerText = name[0]; av.style.background = color || "#fff"; av.style.color = color ? "#fff" : "#075e54"; av.style.backgroundImage = ""; 
      document.getElementById('input-area').classList.toggle('hidden', isSpying);

      if (!isSpying && name !== "Ishan") {
         if (!partnerUid) { const ds = await getDoc(doc(db, "directory", name.toLowerCase())); if(ds.exists()) partnerUid = ds.data().uid; }
         if (partnerUid) { getDoc(doc(db, "users", partnerUid)).then(snap => { if(snap.exists() && snap.data().profilePic) { av.innerText = ""; av.style.backgroundImage = `url('${snap.data().profilePic}')`; }}); }
      }
      loadChat(); loadWallpaper();
    };

    window.goBack = () => {
      if (unsubscribeChat) unsubscribeChat(); 
      document.getElementById('chat-screen').style.display = 'none';
      document.getElementById('contact-screen').style.display = 'flex';
      currentCollection = null; cancelReply();
    };

    function loadChat() {
      unsubscribeChat = onSnapshot(query(collection(db, currentCollection), orderBy("time", "asc")), (snap) => {
        const div = document.getElementById('messages'); const bubble = document.getElementById('typing-bubble-container'); div.innerHTML = ""; 
        snap.forEach(docSnap => {
          const d = docSnap.data(); if(docSnap.id.startsWith('_') || !d.time) return;
          if ((new Date() - d.time.toDate())/36e5 > 24) { deleteDoc(doc(db, currentCollection, docSnap.id)); return; }
          if (d.type === 'image') lastImageSent = d.image;
          if (d.sender !== currentUserDisplay && !d.read && !isSpying) updateDoc(doc(db, currentCollection, docSnap.id), { read: true });

          const isMe = d.sender === currentUserDisplay;
          const msgDiv = document.createElement('div'); msgDiv.className = `msg ${isMe ? 'me' : 'her'}`;
          msgDiv.oncontextmenu = (e) => { e.preventDefault(); if(isAdmin || isMe) { if(confirm("Delete?")) deleteMsg(docSnap.id); } };
          
          let readableText = d.text || "Media";
          if (d.type === 'text' && d.text && isBase64(d.text)) { try { readableText = atob(d.text); } catch(e) {} }
          msgDiv.ondblclick = (e) => { e.preventDefault(); startReply(d.sender, readableText); };
          
          if (!isMe && !isSpying) { const ns = document.createElement('div'); ns.className = 'msg-sender-name'; ns.textContent = d.sender; msgDiv.appendChild(ns); }
          if (d.reply) { const qd = document.createElement('div'); qd.className = 'quote-box'; let rc = d.reply.text; if (isBase64(rc) && !rc.includes(' ')) { try { rc = atob(rc); } catch(e){} } qd.innerHTML = `<strong>${d.reply.sender}</strong><br><span>${rc}</span>`; msgDiv.appendChild(qd); }
          
          if (d.type === 'image') { const img = document.createElement('img'); img.src = d.image; img.onload = scrollToBottom; msgDiv.appendChild(img); } 
          else if (d.type === 'audio') { const ad = document.createElement('div'); ad.className = 'audio-msg'; ad.innerHTML = `<span class="play-icon">‚ñ∂Ô∏è</span><div class="wave"></div>`; ad.querySelector('.play-icon').onclick = () => new Audio(d.audio).play(); msgDiv.appendChild(ad); } 
          else { const cd = document.createElement('div'); cd.className = 'msg-content'; cd.textContent = readableText; msgDiv.appendChild(cd); }
          
          const md = document.createElement('div'); md.className = 'meta-row';
          md.innerHTML = `<span class="time">${d.time.toDate().getHours()}:${String(d.time.toDate().getMinutes()).padStart(2,'0')}</span>` + (isMe ? `<span class="tick" style="color:${d.read ? '#34b7f1' : '#999'}">${d.read ? '‚úì‚úì' : '‚úì'}</span>` : '');
          msgDiv.appendChild(md); div.appendChild(msgDiv);
        });
        
        if(bubble) div.appendChild(bubble);
        else { const nb = document.createElement('div'); nb.id = 'typing-bubble-container'; nb.className = 'typing-bubble'; nb.innerHTML = `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`; div.appendChild(nb); }
        scrollToBottom();
      });

      // Typing Indicator
      onSnapshot(doc(db, currentCollection, "_status"), (snap) => {
        if (!snap.exists()) return;
        const bubble = document.getElementById('typing-bubble-container');
        const isTyping = Object.entries(snap.data()).find(([user, ts]) => user !== currentUserDisplay && ts && (Math.abs(Date.now() - ts.toDate()) < 5000));
        if (bubble) { bubble.style.display = isTyping ? 'flex' : 'none'; if(isTyping) scrollToBottom(); }
      });
    }

    // --- UTILS ---
    function isBase64(str) { try { return btoa(atob(str)) == str; } catch (err) { return false; } }
    window.toggleRecording = async () => {
        const btn = document.getElementById('mic-btn');
        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                mediaRecorder.start(); audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = sendAudio;
                btn.classList.add('active'); setTimeout(() => { if(mediaRecorder.state==='recording') mediaRecorder.stop(); }, 30000);
            } catch(e) { alert("Mic Error"); }
        } else { mediaRecorder.stop(); btn.classList.remove('active'); }
    };
    async function sendAudio() {
        const blob = new Blob(audioChunks, { type: 'audio/webm' }); const reader = new FileReader(); reader.readAsDataURL(blob);
        reader.onloadend = async () => { await addDoc(collection(db, currentCollection), { audio: reader.result, sender: currentUserDisplay, type: 'audio', time: serverTimestamp(), read: false }); };
    }
    window.startReply = (sender, text) => { replyTarget = { sender, text }; document.getElementById('reply-preview').style.display = 'flex'; document.getElementById('reply-to-name').textContent = "Replying to " + sender; document.getElementById('reply-to-text').textContent = text; document.getElementById('txt').focus(); };
    window.cancelReply = () => { replyTarget = null; document.getElementById('reply-preview').style.display = 'none'; };
    window.send = async () => { 
        const txt = document.getElementById('txt'); let val = txt.value.trim(); 
        if(val && currentCollection) { 
            const payload = { text: btoa(val), sender: currentUserDisplay, type: 'text', time: serverTimestamp(), read: false }; 
            if (replyTarget) { payload.reply = replyTarget; cancelReply(); } 
            await addDoc(collection(db, currentCollection), payload); txt.value = ""; txt.style.height = '22px'; txt.focus(); 
        } 
    };
    window.handleImageUpload = (i) => { const f = i.files[0]; if (!f) return; processImage(f, (b) => { addDoc(collection(db, currentCollection), { image: b, sender: currentUserDisplay, type: 'image', time: serverTimestamp(), read: false }); }); i.value = ''; };
    window.handleWallpaperUpload = (i) => { const f = i.files[0]; if(!f) return; processImage(f, (b) => setWallpaper(b)); i.value = ''; document.getElementById('wp-modal').style.display = 'none'; };
    function processImage(file, cb) { const r = new FileReader(); r.onload = (e) => { const i = new Image(); i.src = e.target.result; i.onload = () => { const c = document.createElement('canvas'); const x = c.getContext('2d'); let w = i.width, h = i.height; if (w > 800) { h = (800/w)*h; w = 800; } if (h > 800) { w = (800/h)*w; h = 800; } c.width = w; c.height = h; x.drawImage(i, 0, 0, w, h); cb(c.toDataURL('image/jpeg', 0.7)); } }; r.readAsDataURL(file); }
    async function setWallpaper(u) { await setDoc(doc(db, currentCollection, "_settings"), { wallpaper: u }, { merge: true }); loadWallpaper(); }
    window.useLastPhoto = () => { if(lastImageSent) { setWallpaper(lastImageSent); closeWallpaperModal(); } else alert("No photos!"); };
    window.resetWallpaper = async () => { await setDoc(doc(db, currentCollection, "_settings"), { wallpaper: null }, { merge: true }); closeWallpaperModal(); loadWallpaper(); };
    window.openWallpaperModal = () => document.getElementById('wp-modal').style.display = 'flex';
    window.closeWallpaperModal = () => document.getElementById('wp-modal').style.display = 'none';
    window.deleteMsg = async (id) => { if(currentCollection) await deleteDoc(doc(db, currentCollection, id)); };
    function scrollToBottom() { const d = document.getElementById('messages'); d.scrollTop = d.scrollHeight; } window.scrollToBottom = scrollToBottom;
    function loadWallpaper() { getDoc(doc(db, currentCollection, "_settings")).then(s => { const el = document.getElementById('chat-screen'); if (s.exists() && s.data().wallpaper) { el.style.backgroundImage = `url('${s.data().wallpaper}')`; el.classList.add('has-wallpaper'); } else { el.style.backgroundImage = ''; el.classList.remove('has-wallpaper'); } }); }

    // --- OTHER MODAL ACTIONS ---
    window.openProfileModal = () => document.getElementById('profile-modal').style.display = 'flex';
    window.handleProfilePicUpload = (i) => { const f = i.files[0]; if (!f) return; processImage(f, (b) => { updateDoc(doc(db, "users", currentUserId), { profilePic: b }).then(() => { alert("Updated!"); guestData.profilePic = b; document.getElementById('self-avatar-display').style.backgroundImage = `url('${b}')`; document.getElementById('profile-modal').style.display = 'none'; }); }); i.value = ''; };
    window.renameSelf = async () => { const n = prompt("New Name:", currentUserDisplay); if (!n) return; await updateDoc(doc(db, "users", currentUserId), { name: n }); await deleteDoc(doc(db, "directory", currentUserDisplay.toLowerCase())); await setDoc(doc(db, "directory", n.toLowerCase()), { uid: currentUserId, name: n }); currentUserDisplay = n; alert("Updated!"); document.getElementById('profile-modal').style.display = 'none'; };
    window.changePassword = async () => { const np = prompt("New Password (lowercase):")?.toLowerCase().trim(); if(!np || np.length<3) return; if(!confirm("Change & Logout?")) return; await setDoc(doc(db, "users", np), guestData); await deleteDoc(doc(db, "users", currentUserId)); location.reload(); };
    window.handleAddButton = async () => { if(isAdmin) { const n = prompt("Name:"); const p = prompt("Pass:"); if(!n||!p) return; await setDoc(doc(db, "users", p), { name: n, collection: "chats_"+Date.now(), color: "#"+Math.floor(Math.random()*16777215).toString(16), created: serverTimestamp() }); } else { const t = prompt("Add User:"); if(!t) return; const d = await getDoc(doc(db, "directory", t.toLowerCase())); if(!d.exists()) return alert("404"); const rid = "private_" + [currentUserId, d.data().uid].sort().join("_"); await addDoc(collection(db, `users/${currentUserId}/contacts`), { name: d.data().name, roomId: rid, color: "#000" }); await addDoc(collection(db, `users/${d.data().uid}/contacts`), { name: currentUserDisplay, roomId: rid, color: "#000" }); } };
    
    // DELETE USER
    window.deleteUser = async (e, id) => { 
        e.stopPropagation(); 
        if(confirm("Delete User?")) {
            try {
                // Attempt 1: Get user to clean up directory (name mapping)
                const userRef = doc(db, "users", id);
                const snap = await getDoc(userRef);
                if(snap.exists()) {
                    const data = snap.data();
                    if(data.name) {
                        try {
                            await deleteDoc(doc(db, "directory", data.name.toLowerCase()));
                        } catch(err) { console.log("Directory delete skipped/failed", err); }
                    }
                }
                // Attempt 2: Delete the user document itself
                await deleteDoc(userRef); 
                alert("User Deleted.");
            } catch(error) {
                console.error("Delete failed:", error);
                alert("Error deleting user: " + error.message);
            }
        }
    };

    window.deleteContact = async (e, id) => { e.stopPropagation(); if(confirm("Remove?")) await deleteDoc(doc(db, `users/${currentUserId}/contacts`, id)); };
    window.renameContact = async (e, id, old) => { e.stopPropagation(); const n = prompt("Rename:", old); if(n) await updateDoc(doc(db, `users/${currentUserId}/contacts`, id), { name: n }); };
    
    document.getElementById('pass').addEventListener('keydown', (e) => { if(e.key === 'Enter') attemptLogin(); });
    document.getElementById('txt').addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } });
    document.getElementById('txt').addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; if(this.value === '') this.style.height = '22px'; const now = Date.now(); if (now - lastTypingTime > 2000 && currentCollection) { lastTypingTime = now; setDoc(doc(db, currentCollection, "_status"), { [currentUserDisplay]: serverTimestamp() }, { merge: true }); } });
  </script>
</body>
</html>
